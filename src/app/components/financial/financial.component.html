<!-- Header com gradiente -->
<div class="relative rounded-t-lg bg-gradient-to-r from-[#3377bc] to-[#2a5f9a] p-6 md:p-8 text-white">
  <div class="max-w-6xl mx-auto">
    <div class="text-center">
      <span
        class="text-sm px-3 py-1 rounded-full bg-white/20 text-white border border-white/30 mb-4 inline-block">Financeiro</span>
      <div class="text-3xl md:text-4xl text-white font-semibold font-[Lora] mb-2">Financeiro</div>
      <p class="text-md text-blue-100 font-[Lora]">Gerencie suas finanças</p>
    </div>
  </div>
</div>

<div class="bg-white p-4 pb-0 md:p-8 md:pb-0">
  <div class="flex items-center justify-end">
    <button (click)="upgradeSubscription()"
      class="px-4 py-2 rounded-lg bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white flex items-center gap-2">
      <lucide-icon [img]="crownIcon" class="w-4 h-4 mr-2" />
      <span class="text-sm font-bold">
        Fazer Upgrade
      </span>
    </button>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-8 bg-white p-4 md:p-8">
  <mat-card class="lg:col-span-2 p-6 font-[Lora] border-2 transition-all duration-300 hover:shadow-xl">
    <!-- Status da assinatura -->
    <div class="flex flex-row justify-between items-center mb-8">
      <div class="text-xl text-gray-700 mb-2">
        <div class="flex font-bold flex-row items-center gap-2 ">
          <lucide-icon [img]="creditCardIcon" class="w-6 h-6 text-[#3377bc]"></lucide-icon>
          Assinatura atual
        </div>
        <p class="text-sm text-gray-500">Informações da sua assinatura</p>
      </div>

      @if (subscription.status === 'active') {
      <div class="badge text-white rounded-full bg-green-200 px-4 py-0.5">
        <span class="text-green-900 text-sm text-bold">Ativo</span>
      </div>
      } @else {
      <div class="badge text-white rounded-full bg-red-200 px-4 py-0.5">
        <span class="text-red-900 text-sm text-bold">Inativo</span>
      </div>
      }
    </div>

    <!-- Assinatura atual -->
    <div class="flex flex-row justify-between items-center">
      <div class="text-xl text-gray-700 mb-2">
        <div class="flex font-bold flex-row items-center gap-2 ">
          Plano {{ plan.name }}
        </div>
        <p class="text-sm text-gray-500">Periodicidade da cobrança</p>
      </div>
      <div class="flex flex-col items-end gap-2 ">
        <div class="text-xl text-[#3498db] font-semibold">
          {{ plan.value / 100 | currency: 'BRL' }}
        </div>
        <div class="text-sm text-gray-500">
          por mês
        </div>
      </div>
    </div>

    <hr class="my-4">

    <!-- Recursos inclusos -->
    <div class="text-left mb-8">
      <div class="text-gray-700 text-xl font-bold mb-2">
        Recursos inclusos:
      </div>

      <div>
        @for (feature of plan.feature_list; track feature) {
        <div class="text-gray-700 text-sm mb-1.5">
          {{ feature }}
        </div>
        }
      </div>
    </div>

    <!-- Próxima cobrança -->
    <div
      class="flex flex-row justify-center items-center bg-gradient-to-r from-[#2a5f9a] to-[#3377bc] rounded-lg px-2 py-4 mb-6">
      <div class="flex flex-col md:flex-row gap-2 items-center">
        <div class="flex flex-row gap-2 items-center">
          <lucide-icon [img]="calendarIcon" class="w-6 h-6 text-white"></lucide-icon>
          <div class="text-sm font-semibold text-white">
            Próxima cobrança:
          </div>
        </div>
        <div class="text-md font-semibold text-white">
          {{ subscription.next_execution | date: 'dd/MM/yyyy' }}
        </div>
      </div>
    </div>

    <!-- Renovação -->
    <div
      class="flex flex-row justify-center items-center bg-gradient-to-r from-[#2a5f9a] to-[#3377bc] rounded-lg px-2 py-4">
      <div class="flex flex-col md:flex-row gap-2 items-center">
        <div class="flex flex-row gap-2 items-center">
          <lucide-icon [img]="calendarIcon" class="w-6 h-6 text-white"></lucide-icon>
          <div class="text-sm font-semibold text-white">
            Renovação:
          </div>
        </div>
        <div class="text-md font-semibold text-white">
          {{ subscription.next_renewal | date: 'dd/MM/yyyy' }}
        </div>
      </div>
    </div>
  </mat-card>

  <mat-card class="p-6 font-[Lora] border-2 transition-all duration-300 hover:shadow-xl">
    <div class="flex flex-col justify-between h-full">
      <!-- Próxima cobrança -->
      <div class="text-xl text-gray-700 mb-2">
        <div class="flex font-bold flex-row items-center gap-2 ">
          <lucide-icon [img]="alertCircleIcon" class="w-6 h-6 text-orange-500"></lucide-icon>
          Próxima cobrança
        </div>
        <p class="text-sm text-gray-500">Vencimento em {{ subscription.next_execution | date: 'dd/MM/yyyy' }}</p>

        <hr class="my-4">
      </div>

      <div>
        <!-- Total a pagar -->
        <div class="flex justify-center py-6 bg-gray-100 rounded-lg mb-4">
          <div class="flex flex-col items-center text-center">
            <div class="text-gray-700 text-2xl font-bold mb-1">
              {{ plan.value / 100 | currency: 'BRL' }}
            </div>
            <p class="text-gray-500 text-sm">Total a pagar</p>
          </div>
        </div>
      </div>

      <div>
        <!-- Itens da fatura -->
        <div class="text-gray-700 font-bold mb-2">
          Itens da fatura:
        </div>

        <div class="flex flex-row justify-between items-center">
          <div class="text-gray-700 text-sm">
            Plano {{ plan.name }} - {{ subscription.next_execution | date: 'dd/MM/yyyy' }}
          </div>
          <div class="text-gray-700 text-sm">
            {{ plan.value / 100 | currency: 'BRL' }}
          </div>
        </div>
      </div>
    </div>
  </mat-card>

  @if (subscription.efi_subscription_id && subscription.card) {
  <mat-card class="p-6 font-[Lora] border-2 transition-all duration-300 hover:shadow-xl">
    <!-- Título -->
    <div class="text-xl flex font-bold flex-row items-center gap-2 text-gray-700">
      <lucide-icon [img]="creditCardIcon" class="w-6 h-6 text-gray-700"></lucide-icon>
      Cartão Cadastrado
    </div>

    <hr class="my-4">

    <mat-card class="bg-gradient-to-r from-yellow-500 to-orange-500 p-4">
      <div class="flex flex-col justify-between h-full">
        <!-- Cartão cadastrado -->
        <div class="text-white text-center text-md tracking-widest mb-4">
          {{ account.name }}
        </div>

        <div class="flex flex-row justify-between items-centerh-full">
          <div class="text-white">
            <p class="text-md md:text-xl tracking-widest">
              {{ subscription.card.card_mask }}
            </p>
            <p class="text-md">
              Vencimento: {{ subscription.card.expiration_date }}
            </p>
          </div>
  
          <!-- Brand -->
          <div class="flex flex-row justify-center items-center gap-2">
            <div class="flex flex-col justify-center items-center">
              <app-card-brand-icon
                [brand]="subscription.card.brand" 
                width="40px" 
                height="25px"
                cssClasses="w-10 h-10 mb-2">
              </app-card-brand-icon>
  
              <p class="text-sm text-white">
                {{ subscription.card.brand | titlecase }}
              </p>
            </div>
          </div>
        </div>
  
        <hr class="text-white my-4">
  
        @if (validateUserService.isOwnerOrManager(currentUser.type)) {
          <!-- Alterar cartão -->
          <div class="flex flex-row justify-center items-center">
            <button class="bg-white text-[#3377bc] hover:bg-gray-100 px-4 py-2 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-all duration-300">
              <lucide-icon [img]="refreshIcon" class="w-4 h-4 mr-2"></lucide-icon>
              Alterar cartão
            </button>
          </div>
        }
      </div>
    </mat-card>
  </mat-card>
  }
</div>

@if (subscription.efi_subscription_id) {
  <div class="bg-white gap-8 p-4 md:p-8">
    <mat-card class="p-6 font-[Lora] border-2 transition-all duration-300 hover:shadow-xl">
      <div class="text-xl text-gray-700 mb-2">
        Histórico de pagamentos
      </div>
      <p class="text-sm text-gray-500">
        Suas últimas transações
      </p>
  
      <hr class="my-4">
  
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b">
              <th class="text-left py-3 px-4 font-medium text-gray-600">Data</th>
              <th class="text-left py-3 px-4 font-medium text-gray-600">Fatura</th>
              <th class="text-left py-3 px-4 font-medium text-gray-600">Valor</th>
              <th class="text-center py-3 px-4 font-medium text-gray-600">Status</th>
              <th class="text-center py-3 px-4 font-medium text-gray-600">Ações</th>
            </tr>
          </thead>
          <tbody>
            @for (payment of subscription.payment_history; track payment) {
            <tr class="border-b hover:bg-gray-50">
              <td class="py-3 px-4">{{ payment.created_at | date: 'dd/MM/yyyy' }}</td>
              <td class="py-3 px-4 font-mono text-sm">{{ payment.id }}</td>
              <td class="py-3 px-4 font-medium">{{ payment.total / 100 | currency: 'BRL' }}</td>
              <td class="py-3 px-4">
                <div class="badge text-center rounded-full px-4 py-0.5"
                  [class]="efiService.getPaymentStatusClasses(payment.status).bgClass">
                  <span class="max-w-fit text-sm font-semibold"
                    [class]="efiService.getPaymentStatusClasses(payment.status).textClass">
                    {{ sanitizePaymentStatus(payment.status) }}
                  </span>
                </div>
              </td>
              <td class="py-3 px-4">
                <div class="flex flex-col md:flex-row gap-2 justify-center items-center">
  
                  <!-- Pagar agora -->
                  @if (['unpaid'].includes(payment.status)) {
                  <button
                    (click)="retryPayment(payment.id, $event)"
                    [disabled]="isPaymentLoading(payment.id)"
                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-[#3377bc] bg-white border border-[#3377bc] rounded-lg hover:bg-[#3377bc] hover:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                    <div class="flex flex-col md:flex-row items-center gap-2">
                      @if (isPaymentLoading(payment.id)) {
                        <mat-spinner color="primary" diameter="20"></mat-spinner>
                      } @else {
                        <lucide-icon [img]="refreshIcon" class="w-4 h-4"></lucide-icon>
                      }
                      <span class="text-sm">
                        @if (isPaymentLoading(payment.id)) {
                          Processando...
                        } @else {
                          Reprocessar pagamento
                        }
                      </span>
                    </div>
                  </button>
                  }
  
                  <!-- Pagar com cartão -->
                  @if (['expired', 'canceled'].includes(payment.status)) {
                  <button
                    (click)="payWithCard(payment.id, $event)"
                    [disabled]="isPaymentLoading(payment.id)"
                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-[#3377bc] bg-white border border-[#3377bc] rounded-lg hover:bg-[#3377bc] hover:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                    <div class="flex flex-col md:flex-row items-center gap-2 transition-all duration-300">
                      @if (isPaymentLoading(payment.id)) {
                        <mat-spinner color="primary" diameter="20"></mat-spinner>
                      } @else {
                        <lucide-icon [img]="creditCardIcon" class="w-4 h-4"></lucide-icon>
                      }
                      <span class="text-sm">
                        @if (isPaymentLoading(payment.id)) {
                          Processando...
                        } @else {
                          Pagar com cartão
                        }
                      </span>
                    </div>
                  </button>
                  }
                </div>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </mat-card>
  </div>
}

<!-- CTA -->
@if (plan.name !== "Ouro") {
<div class="bg-white rounded-b-lg p-4 md:p-8">
  <div class="text-left w-full bg-gradient-to-r from-[#2a5f9a] to-[#3377bc] rounded-lg px-6 py-10 mb-10">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
      <div class="col-span-2">
        <div class="text-xl text-white font-bold mb-2">
          Precisa de mais recursos?
        </div>
        <div class="text-md text-white/80">
          Faça upgrade para o plano que melhor atende às suas necessidades.
        </div>

        <hr class="my-4">

        <div class="text-md text-white/80">
          @for (feature of goldPlan.feature_list; track feature) {
          <div class="text-md text-white/80">
            <p>{{ feature }}</p>
          </div>
          }
        </div>
      </div>

      <div class="col-span-1 flex justify-center md:justify-end">
        <button (click)="upgradeSubscription()"
          class="rounded-lg bg-white text-[#3377bc] hover:bg-gray-100 px-4 py-2 flex items-center justify-center">
          <lucide-icon [img]="trendingUpIcon" class="w-4 h-4 mr-2"></lucide-icon>
          Ver planos
        </button>
      </div>
    </div>
  </div>
</div>
}