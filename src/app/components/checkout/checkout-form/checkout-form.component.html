<!-- Header gradient -->
<div class="relative bg-gradient-to-r from-[#3377bc] to-[#2a5f9a] p-6 text-white mb-4 md:mb-0">
  <div class="text-center">
    <span class="text-sm px-2 rounded-md bg-white/20 text-white border border-white/30 mb-3">Nova Assinatura</span>
    <div class="text-3xl text-white font-semibold font-[Lora]">Finalizar Assinatura</div>
    <div class="text-sm text-white/70">
      Você selecionou o plano <span class="text-xl font-bold">{{ data.plan.name }}</span>
    </div>
  </div>
  <button (click)="dialogRef.close()" class="absolute top-4 right-4 text-white/80 hover:text-white transition-colors">
    <mat-icon>close</mat-icon>
  </button>
</div>
<mat-dialog-content class="font-[Lora]">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <form [formGroup]="form" class="space-y-4 md:space-y-6">
      <mat-card class="w-[90%] mx-auto shadow-md p-3 md:p-4 mb-4 md:mb-6">
        <div class="pl-2 text-xl font-[Lora] text-gray-700 font-semibold mb-4 flex flex-row items-center gap-2">
          <lucide-icon [img]="userIcon" class="w-6 h-6" />
          Dados Pessoais
        </div>

        <hr class="mb-4">

        <!-- Nome -->
        <div class="mb-4">
          <label for="name" class="text-sm block text-gray-700 font-[Lora] mb-1">Nome do Titular</label>
          <div class="relative">
            <input id="name" name="name" type="text" formControlName="name"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#2fade3]"
              placeholder="Insira o nome do titular do cartão">
            @if (form.get('name')?.invalid && form.get('name')?.touched) {
            <mat-error>
              @if (form.get('name')?.hasError('fullNameRequired')) {
              Nome do titular deve conter nome e sobrenome
              } @else if (form.get('name')?.hasError('invalidWordLength')) {
              Cada palavra deve ter pelo menos 2 caracteres
              } @else if (form.get('name')?.hasError('required')) {
              Nome do titular é obrigatório
              }
            </mat-error>
            }
          </div>
        </div>

        <!-- Email -->
        <div class="mb-4">
          <label for="name" class="text-sm block text-gray-700 font-[Lora] mb-1">Email</label>
          <div class="relative">
            <input id="email" name="email" type="text" formControlName="email"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#2fade3]"
              placeholder="Insira o email">
            @if (form.get('email')?.invalid && form.get('email')?.touched) {
            <mat-error>
              @if (form.get('email')?.hasError('required')) {
              Email é obrigatório
              }
            </mat-error>
            }
          </div>
        </div>

        <!-- Razão Social -->
        <div class="mb-4">
          <label for="company_name" class="text-sm block text-gray-700 font-[Lora] mb-1">Razão Social (Opcional)</label>
          <div class="relative">
            <input id="company_name" name="company_name" type="text" formControlName="company_name"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#2fade3]"
              placeholder="Insira a razão social">
          </div>
        </div>

        <!-- CPF/CNPJ -->
        <div class="mb-4">
          <label for="cpf_cnpj" class="text-sm block text-gray-700 font-[Lora] mb-1">CPF/CNPJ</label>
          <div class="relative">
            <input id="cpf_cnpj" name="cpf_cnpj" type="text" formControlName="cpf_cnpj"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#2fade3]"
              placeholder="Insira o CPF/CNPJ"
              (input)="onCpfCnpjInput($event)"
              (blur)="formatDocument()"
              maxlength="18">

              @if (form.get('cpf_cnpj')?.invalid && form.get('cpf_cnpj')?.touched) {
                <mat-error>
                  @if (form.get('cpf_cnpj')?.hasError('cpf_cnpj')) {
                    {{ form.get('cpf_cnpj')?.errors?.['cpf_cnpj']?.message || 'Documento inválido' }}
                  } @else if (form.get('cpf_cnpj')?.hasError('required')) {
                    Documento é obrigatório
                  }
                </mat-error>
              }
          </div>
        </div>
      </mat-card>

      <mat-card class="w-[90%] mx-auto shadow-md p-3 md:p-4 mb-4 md:mb-6">
        <div class="pl-2 text-xl font-[Lora] text-gray-700 font-semibold mb-4 flex flex-row items-center gap-2">
          <lucide-icon [img]="creditCardIcon" class="w-6 h-6" />
          Dados do cartão
        </div>

        <hr class="mb-4">

        <p class="text-sm text-gray-600 mb-2">Cartões aceitos:</p>
        <div class="flex items-center gap-2 flex-wrap mb-4">
          <div class="bg-white border rounded px-2 py-1 text-xs font-semibold text-blue-600">VISA</div>
          <div class="bg-white border rounded px-2 py-1 text-xs font-semibold text-red-600">
            MASTERCARD
          </div>
          <div class="bg-white border rounded px-2 py-1 text-xs font-semibold text-blue-800">AMEX</div>
          <div class="bg-white border rounded px-2 py-1 text-xs font-semibold text-yellow-600">ELO</div>
          <div class="bg-white border rounded px-2 py-1 text-xs font-semibold text-red-700">
            HIPERCARD
          </div>
        </div>

        <hr class="mb-4">

        <!-- Nome -->
        <div class="mb-4">
          <label for="holder_name" class="text-sm block text-gray-700 font-[Lora] mb-1">Nome no cartão</label>
          <div class="relative">
            <input id="holder_name" name="holder_name" type="text" formControlName="holder_name"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#2fade3]"
              placeholder="Insira o nome no cartão">
            @if (form.get('holder_name')?.invalid && form.get('holder_name')?.touched) {
            <mat-error>
              @if (form.get('holder_name')?.hasError('fullNameRequired')) {
              Nome no cartão deve conter nome e sobrenome
              } @else if (form.get('holder_name')?.hasError('invalidWordLength')) {
              Cada palavra deve ter pelo menos 2 caracteres
              } @else if (form.get('holder_name')?.hasError('required')) {
              Nome no cartão é obrigatório
              }
            </mat-error>
            }
          </div>
        </div>

        <!-- Número do cartão -->
        <div class="mb-4">
          <label for="card_number" class="text-sm block text-gray-700 font-[Lora] mb-1">Número do Cartão</label>
          <div class="relative">
            <input id="card_number" name="card_number" type="text" formControlName="card_number"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#2fade3]"
              placeholder="0000 0000 0000 0000"
              (blur)="identifyBrand(form.get('card_number')?.value)"
              (input)="onCardNumberInput($event)"
              maxlength="19">
            @if (form.get('card_number')?.invalid && form.get('card_number')?.touched) {
            <mat-error>
              @if (form.get('card_number')?.hasError('invalidCardLength')) {
                Número do cartão deve ter entre 13 e 19 dígitos
              } @else if (form.get('card_number')?.hasError('invalidCardNumber')) {
                Número do cartão inválido
              } @else if (form.get('card_number')?.hasError('required')) {
                Número do cartão é obrigatório
              }
            </mat-error>
            }
          </div>
        </div>

        <!-- Bandeira -->
        <div class="mb-4">
          <label for="brand" class="text-sm block text-gray-700 font-[Lora] mb-1">Bandeira</label>
          <div class="relative">
            <input id="brand" name="brand" type="text" formControlName="brand" readonly
              class="w-full text-gray-400 px-4 py-2 border rounded-lg cursor-not-allowed"
              [value]="form.get('brand')?.value">
          </div>
        </div>

        <!-- Validade -->
        <div class="mb-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="expiration_month" class="text-sm block text-gray-700 font-[Lora] mb-1">Mês</label>
              <div class="relative">
                <input id="expiration_month" name="expiration_month" type="text" formControlName="expiration_month"
                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#2fade3]"
                  placeholder="MM"
                  (input)="onExpirationMonthInput($event)"
                  maxlength="2">
                @if (form.get('expiration_month')?.invalid && form.get('expiration_month')?.touched) {
                <mat-error>
                  @if (form.get('expiration_month')?.hasError('invalidMonthLength')) {
                    Mês deve ter 2 dígitos
                  } @else if (form.get('expiration_month')?.hasError('invalidMonthRange')) {
                    Mês deve ser entre 01 e 12
                  } @else if (form.get('expiration_month')?.hasError('required')) {
                    Mês é obrigatório
                  }
                </mat-error>
                }
              </div>
            </div>
            <div>
              <label for="expiration_year" class="text-sm block text-gray-700 font-[Lora] mb-1">Ano</label>
              <div class="relative">
                <input id="expiration_year" name="expiration_year" type="text" formControlName="expiration_year"
                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#2fade3]"
                  placeholder="AAAA"
                  (input)="onExpirationYearInput($event)"
                  maxlength="4">
                @if (form.get('expiration_year')?.invalid && form.get('expiration_year')?.touched) {
                <mat-error>
                  @if (form.get('expiration_year')?.hasError('invalidYearLength')) {
                    Ano deve ter 4 dígitos
                  } @else if (form.get('expiration_year')?.hasError('invalidYearRange')) {
                    Ano deve ser válido
                  } @else if (form.get('expiration_year')?.hasError('required')) {
                    Ano é obrigatório
                  }
                </mat-error>
                }
              </div>
            </div>
          </div>
        </div>

        <!-- CVV -->
        <div class="mb-4">
          <label for="security_code" class="text-sm block text-gray-700 font-[Lora] mb-1">CVV</label>
          <div class="relative">
            <input id="security_code" name="security_code" type="text" formControlName="security_code"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#2fade3]"
              placeholder="123"
              (input)="onSecurityCodeInput($event)"
              maxlength="3">
            @if (form.get('security_code')?.invalid && form.get('security_code')?.touched) {
            <mat-error>
              @if (form.get('security_code')?.hasError('invalidSecurityCodeLength')) {
                CVV deve ter 3 dígitos
              } @else if (form.get('security_code')?.hasError('required')) {
                CVV é obrigatório
              }
            </mat-error>
            }
          </div>
        </div>
      </mat-card>
    </form>

    <div class="flex flex-col">
      <mat-card class="w-[90%] mx-auto shadow-md p-3 md:p-4 mb-4 md:mb-6">
        <div class="pl-2 text-xl font-[Lora] text-gray-700 font-semibold mb-4 flex flex-row items-center gap-2">
          <lucide-icon [img]="cartIcon" class="w-6 h-6" />
          Resumo do pedido
        </div>
  
        <hr class="mb-4">
  
        <div class="flex flex-row gap-2 font-[Lora] items-center">
          <div class="inline-flex items-center justify-center w-14 h-14 rounded-2xl"
            [class]="data.plan.name === 'Ouro' ? 'bg-gradient-to-r from-[#3498db] to-[#5e3498]' : 'bg-gray-100'">
            <lucide-icon [img]="sanitizeIcon(data.plan.name)"
              [class]="data.plan.name === 'Ouro' ? 'text-white' : 'text-[#3498db]'" />
          </div>
  
          <div class="flex flex-col items-center">
            <div class="text-lg font-semibold text-gray-700">Plano {{ data.plan.name }}</div>
  
            @if (data.plan.name === 'Ouro') {
              <div class="badge bg-gradient-to-r from-[#3498db] to-[#5e3498] text-white px-4 py-1 rounded-full text-xs md:text-sm flex flex-row items-center justify-between gap-2">
                <lucide-icon [img]="starIcon" class="w-4 h-4" />
                Mais Popular
              </div>
            }
          </div>
        </div>
  
        <hr class="my-4">
  
        <div class="flex flex-col gap-2 font-[Lora]">
          <div class="value flex flex-row justify-between items-center">
            <div class="text-lg text-gray-700">Plano {{ data.plan.name }}</div>
            <div class="text-lg text-gray-700">{{ data.plan.value / 100 | currency: 'BRL' }}</div>
          </div>
          <div class="period flex flex-row justify-between items-center">
            <div class="text-sm text-gray-700">Periodicidade</div>
            <div class="text-sm text-gray-700">Mensal</div>
          </div>
          <div class="next_payment flex flex-row justify-between items-center">
            <div class="text-sm text-gray-700">Próximo pagamento</div>
            <div class="text-sm text-gray-700">{{ nextPayment }}</div>
          </div>
        </div>
  
        <hr class="my-4">
  
        <div class="flex flex-row justify-between items-center font-[Lora] mb-4">
          <div class="text-xl text-gray-700 font-semibold">Total</div>
          <div class="text-xl text-[#3498db] font-semibold">{{ data.plan.value / 100 | currency: 'BRL' }}</div>
        </div>
  
        <div class="bg-gray-200 p-4 rounded-lg flex flex-row gap-2 items-center">
          <lucide-icon [img]="padlockIcon" class="text-gray-700 w-6 h-6" />
          <div class="text-sm text-center text-gray-700 font-[Lora]">
            Pagamento 100% seguro e criptografado
          </div>
        </div>
      </mat-card>
  
      <mat-card class="w-[90%] mx-auto shadow-md p-3 md:p-4 mb-4 md:mb-6">
        <div class="pl-2 text-xl font-[Lora] text-gray-700 font-semibold mb-4 flex flex-row items-center gap-2">
          <lucide-icon [img]="rocketIcon" class="w-6 h-6" />
          Recursos do plano
        </div>
  
        <hr class="mb-4">

        <div class="flex flex-col gap-2 font-[Lora]">
          @for (feature of data.plan.feature_list; track feature) {
          <div class="flex flex-row justify-between items-center">
            <div class="text-sm text-gray-700">{{ feature }}</div>
          </div>
          }
        </div>
      </mat-card>
    </div>
  </div>

  <hr class="my-4">

  <div class="w-[90%] mx-auto pb-4 md:pb-0 flex justify-center">
    <button
      (click)="onSubmit()"
      [disabled]="form.invalid"
      class="w-full bg-gradient-to-r from-[#3498db] to-[#5e3498] text-white inline-flex gap-2 items-center px-4 py-2 text-sm font-medium rounded-lg hover:bg-gradient-to-r hover:from-[#5e3498] hover:to-[#3498db] focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
      <span class="text-center w-full flex flex-row items-center justify-center gap-2">
        @if (isLoading) {
        <mat-spinner class="text-white" diameter="20"></mat-spinner>
        } @else {
        <lucide-icon [img]="padlockIcon" class="w-4 h-4" />
        Finalizar Assinatura
        }
      </span>
    </button>
  </div>
</mat-dialog-content>